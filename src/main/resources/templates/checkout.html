<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Cookiegram Bakery - Checkout</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script th:src="@{/js/theme-loader.js}"></script>

    <style>
       body {
         font-family: 'Poppins', sans-serif;
         background-color: #f8f9fa;
       }
       main {
         padding-top: 7rem;
         padding-bottom: 7rem;
       }
       .color-swatch {
         display: inline-block;
         width: 20px;
         height: 20px;
         border-radius: 50%;
         border: 1px solid #ccc;
         vertical-align: middle;
         margin-right: 8px;
         background-color: #eee;
       }
       #shipping-cost-loader {
           display: none; /* Hide spinner by default */
       }
    </style>
</head>
<body>

<div th:replace="fragments/nav :: mainNav"></div>

<main class="container">
    <div class="row g-5">
        <div class="col-md-6">
            <h2 class="mb-4">Checkout</h2>
            <div class="card">
                <div class="card-body">
                    <form th:action="@{/charge}" method="post" id="payment-form">
                        
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="amount" id="amount-hidden" th:value="${amount}" />
                        <input type="hidden" name="shippingCost" id="shipping-cost-hidden" value="0.0" />
                        <input type="hidden" name="deliveryDate" id="delivery-date-hidden" />
                        
                        <div class="accordion" id="checkoutAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        Shipping Address
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#checkoutAccordion">
                                    <div class="accordion-body">
                                        <div th:if="${not #authorization.expression('isAuthenticated()')}">
                                            <h5 class="mb-3">Contact Information</h5>
                                            <div class="mb-3">
                                                <label for="guestEmail" class="form-label">Email</label>
                                                <input type="email" id="guestEmail" name="guestEmail" class="form-control" required>
                                            </div>
                                        </div>
                
                                        <div class="mb-3">
                                            <label for="shippingName" class="form-label">Full Name</label>
                                            <input type="text" id="shippingName" name="shippingName" class="form-control" th:value="${shippingAddress.name != null} ? ${shippingAddress.name} : ${defaultName}" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="shippingAddressLine1" class="form-label">Address Line 1</label>
                                            <input type="text" id="shippingAddressLine1" name="shippingAddressLine1" class="form-control" th:value="${shippingAddress.addressLine1}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="shippingAddressLine2" class="form-label">Address Line 2 (Optional)</label>
                                            <input type="text" id="shippingAddressLine2" name="shippingAddressLine2" class="form-control" th:value="${shippingAddress.addressLine2}">
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="shippingCity" class="form-label">City</label>
                                                <input type="text" id="shippingCity" name="shippingCity" class="form-control" th:value="${shippingAddress.city}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="shippingProvince" class="form-label">Province</label>
                                                <input type="text" id="shippingProvince" name="shippingProvince" class="form-control" th:value="${shippingAddress.province}" placeholder="e.g., ON" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="shippingPostalCode" class="form-label">Postal Code</label>
                                                <input type="text" id="shippingPostalCode" name="shippingPostalCode" class="form-control" th:value="${shippingAddress.postalCode}" placeholder="A1B 2C3" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="shippingCountry" class="form-label">Country</label>
                                                <input type="text" id="shippingCountry" name="shippingCountry" class="form-control" th:value="${shippingAddress.country != null} ? ${shippingAddress.country} : 'Canada'" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        Billing Address
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#checkoutAccordion">
                                    <div class="accordion-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="sameAsShipping" checked>
                                            <label class="form-check-label" for="sameAsShipping">
                                                Same as shipping address
                                            </label>
                                        </div>
                                        <div id="billingAddressForm" style="display: none;">
                                            <div class="mb-3">
                                                <label for="billingName" class="form-label">Full Name</label>
                                                <input type="text" id="billingName" name="billingName" class="form-control">
                                            </div>
                                            <div class="mb-3">
                                                <label for="billingAddressLine1" class="form-label">Address Line 1</label>
                                                <input type="text" id="billingAddressLine1" name="billingAddressLine1" class="form-control">
                                            </div>
                                            <div class="mb-3">
                                                <label for="billingAddressLine2" class="form-label">Address Line 2 (Optional)</label>
                                                <input type="text" id="billingAddressLine2" name="billingAddressLine2" class="form-control">
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="billingCity" class="form-label">City</label>
                                                    <input type="text" id="billingCity" name="billingCity" class="form-control">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="billingProvince" class="form-label">Province</label>
                                                    <input type="text" id="billingProvince" name="billingProvince" class="form-control" placeholder="e.g., ON">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="billingPostalCode" class="form-label">Postal Code</label>
                                                    <input type="text" id="billingPostalCode" name="billingPostalCode" class="form-control" placeholder="A1B 2C3">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="billingCountry" class="form-label">Country</label>
                                                    <input type="text" id="billingCountry" name="billingCountry" class="form-control" value="Canada">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                        Delivery Date
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#checkoutAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-3">
                                            <label for="deliveryDate" class="form-label">Select a delivery date</label>
                                            <input type="text" id="deliveryDate" name="deliveryDate" class="form-control" placeholder="Choose a date..." required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingFour">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                        Payment
                                    </button>
                                </h2>
                                <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#checkoutAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-3">
                                            <label for="card-element" class="form-label">Credit or debit card</label>
                                            <div id="card-element" class="form-control"></div>
                                            <div id="card-errors" role="alert" class="text-danger mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" id="order-id" name="orderId" th:value="${order != null} ? ${order.id} : ''" />
                        
                        <div class="d-grid gap-2 mt-4">
                            <!-- Return button -->
                            <a th:if="${order == null}" th:href="@{/cart}" class="btn btn-secondary">Back to Cart</a>
                            <a th:if="${order != null}" th:href="@{|/order/edit/${order.id}|}" class="btn btn-secondary">Cancel Changes</a>

                            <button th:unless="${order != null}" class="btn btn-primary" id="payment-button" disabled>
                                <span id="payment-button-loader" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                <span id="payment-button-text">Submit Payment</span>
                            </button>
                        </div>

                        <div th:if="${order != null}" class="d-grid gap-2 mt-4">
                            <button class="btn btn-success" id="save-order-button">
                                <span id="save-order-button-loader" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                <span id="save-order-button-text">Save Details</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <h2 class="mb-4">Order Summary</h2>
            <div class="card">
                <div class="card-body">
                    <div class="list-group list-group-flush mb-3">
                        <div th:each="item : ${cartItems}" class="list-group-item p-3">
                            <div class="row align-items-center">
                                <div class="col-2">
                                    <img th:src="@{/images/yourmessagehere-yellow-2022.png}" alt="Cookie" class="img-fluid" style="max-width: 50px;">
                                </div>
                                <div class="col-7">
                                    <h6 class="mb-0" th:text="${item.name}">Large Cookiegram</h6>
                                    <small class="text-muted" th:text="${item.message}">"Happy Birthday!"</small>
                                    <div>
                                        <span class="color-swatch" th:style="'background-color: ' + ${item.icingColorHex}"></span>
                                        <small th:text="${item.icingColorName}">Cool Blue</small>
                                    </div>
                                </div>
                                <div class="col-3 text-end">
                                    <span class="fw-bold" th:text="|${'$'}${#numbers.formatDecimal(item.price, 1, 2)}|">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            Subtotal
                            <span class="fw-bold" id="subtotal" th:data-subtotal="${subtotal}" th:text="|${'$'}${#numbers.formatDecimal(subtotal, 1, 2)}|">$0.00</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            Taxes (13%)
                            <span class="fw-bold" id="tax" th:data-tax="${tax}" th:text="|${'$'}${#numbers.formatDecimal(tax, 1, 2)}|">$0.00</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span>
                                Shipping
                                <span id="shipping-cost-loader" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
                            </span>
                            <span class="fw-bold" id="shipping-cost-display">$0.00</span>
                        </li>
                        <div id="shipping-error" class="text-danger mb-2" style="font-size: 0.9em; padding-left: 1.25rem;"></div>

                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 fw-bold h5">
                            Total
                            <span id="total-display" th:text="|${'$'}${#numbers.formatDecimal(total, 1, 2)}|">$0.00</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="fragments/footer :: mainFooter"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://js.stripe.com/v3/"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script th:inline="javascript">
    /*<![CDATA[*/

    // --- STATE AND ELEMENTS ---
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    const stripe = Stripe(/*[[${stripePublicKey}]]*/);
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    const form = document.getElementById('payment-form');
    const paymentButton = document.getElementById('payment-button');
    const saveOrderButton = document.getElementById('save-order-button');
    const cardErrorsEl = document.getElementById('card-errors');
    const shippingLoaderEl = document.getElementById('shipping-cost-loader');
    const shippingErrorEl = document.getElementById('shipping-error');
    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const shippingCostDisplayEl = document.getElementById('shipping-cost-display');
    const totalDisplayEl = document.getElementById('total-display');
    const amountHiddenEl = document.getElementById('amount-hidden');
    const shippingCostHiddenEl = document.getElementById('shipping-cost-hidden');
    const sameAsShippingCheckbox = document.getElementById('sameAsShipping');
    const billingAddressForm = document.getElementById('billingAddressForm');

    const shippingFields = ['shippingName', 'shippingAddressLine1', 'shippingCity', 'shippingProvince', 'shippingPostalCode', 'shippingCountry'];
    const billingFields = ['billingName', 'billingAddressLine1', 'billingCity', 'billingProvince', 'billingPostalCode', 'billingCountry'];
    const deliveryDateField = 'deliveryDate';

    let subtotal = parseFloat(subtotalEl.getAttribute('data-subtotal'));
    let tax = parseFloat(taxEl.getAttribute('data-tax'));
    let currentShippingCost = 0.0;
    let isCardComplete = false;

    // --- CORE FUNCTIONS ---

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    function checkFormValidity() {
        let isFormValid = true;

        // 1. Check shipping fields
        for (const id of shippingFields) {
            const input = document.getElementById(id);
            if (!input || input.value.trim() === '') {
                isFormValid = false;
                break;
            }
        }

        // 2. Check billing fields if checkbox is unchecked
        if (isFormValid && !sameAsShippingCheckbox.checked) {
            for (const id of billingFields) {
                const input = document.getElementById(id);
                if (!input || input.value.trim() === '') {
                    isFormValid = false;
                    break;
                }
            }
        }

        // 3. Check delivery date
        if (isFormValid) {
            const deliveryDateInput = document.getElementById(deliveryDateField);
            if (!deliveryDateInput || deliveryDateInput.value.trim() === '') {
                isFormValid = false;
            }
        }
        
        // 4. Check Stripe card element
        if (!isCardComplete) {
            isFormValid = false;
        }

        // 5. Enable/disable button
        if (paymentButton) {
            paymentButton.disabled = !isFormValid;
        }
        if (saveOrderButton) {
            saveOrderButton.disabled = !isFormValid;
        }
    }
    
    async function calculateShipping() {
        toggleSpinner(true); 
        shippingErrorEl.textContent = ''; 
        
        const address = {
            postalCode: document.getElementById('shippingPostalCode').value
        };

        if (!address.postalCode) {
            toggleSpinner(false);
            updateOrderSummary();
            checkFormValidity();
            return; 
        }

        try {
            const response = await fetch('/api/shipping/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
                body: JSON.stringify(address)
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Could not calculate shipping.');

            currentShippingCost = parseFloat(data.shippingCost);
            shippingErrorEl.textContent = '';

        } catch (error) {
            shippingErrorEl.textContent = error.message;
            currentShippingCost = 0;
        } finally {
            toggleSpinner(false);
            updateOrderSummary();
            checkFormValidity();
        }
    }

    function updateOrderSummary() {
        const newTotal = subtotal + tax + currentShippingCost;
        shippingCostDisplayEl.textContent = `$${currentShippingCost.toFixed(2)}`;
        totalDisplayEl.textContent = `$${newTotal.toFixed(2)}`;
        shippingCostHiddenEl.value = currentShippingCost.toFixed(2);
        amountHiddenEl.value = (newTotal * 100).toFixed(0);
    }

    function toggleSpinner(isLoading, buttonType = 'shipping') {
        let spinnerEl, textEl, buttonEl;

        if (buttonType === 'payment' && paymentButton) {
            spinnerEl = document.getElementById('payment-button-loader');
            textEl = document.getElementById('payment-button-text');
            buttonEl = paymentButton;
        } else if (buttonType === 'save' && saveOrderButton) {
            spinnerEl = document.getElementById('save-order-button-loader');
            textEl = document.getElementById('save-order-button-text');
            buttonEl = saveOrderButton;
        } else {
             shippingLoaderEl.style.display = isLoading ? 'inline-block' : 'none';
             return;
        }

        if (isLoading) {
            textEl.style.display = 'none';
            spinnerEl.style.display = 'inline-block';
            buttonEl.disabled = true;
        } else {
            textEl.style.display = 'inline-block';
            spinnerEl.style.display = 'none';
            checkFormValidity(); // Re-check validity to set button state
        }
    }
    
    // --- EVENT LISTENERS ---

    const debouncedCalculateShipping = debounce(calculateShipping, 600);

    // Listen to all required fields for validation
    const allRequiredFields = [...shippingFields, ...billingFields, deliveryDateField];
    allRequiredFields.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', checkFormValidity);
        }
    });

    // Special handling for postal code to trigger shipping calculation
    const postalCodeInput = document.getElementById('shippingPostalCode');
    if (postalCodeInput) {
        postalCodeInput.addEventListener('input', debouncedCalculateShipping);
    }

    // Stripe card element listener
    cardElement.on('change', (event) => {
        if (event.error) {
            cardErrorsEl.textContent = event.error.message;
            isCardComplete = false;
        } else {
            cardErrorsEl.textContent = '';
            isCardComplete = event.complete;
        }
        checkFormValidity();
    });

    // "Same as shipping" checkbox listener
    sameAsShippingCheckbox.addEventListener('change', function() {
        billingAddressForm.style.display = this.checked ? 'none' : 'block';
        checkFormValidity();
    });

    // Form submission handlers
    if (paymentButton) {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            toggleSpinner(true, 'payment');
            const { token, error } = await stripe.createToken(cardElement);
            if (error) {
                cardErrorsEl.textContent = error.message;
                toggleSpinner(false, 'payment');
            } else {
                const hiddenInput = document.createElement('input');
                hiddenInput.setAttribute('type', 'hidden');
                hiddenInput.setAttribute('name', 'stripeToken');
                hiddenInput.setAttribute('value', token.id);
                form.appendChild(hiddenInput);
                form.submit();
            }
        });
    }

    if (saveOrderButton) {
        saveOrderButton.addEventListener('click', (event) => {
            event.preventDefault();
            toggleSpinner(true, 'save');
            const orderId = document.getElementById('order-id').value;
            form.action = '/checkout/edit/' + orderId;
            form.submit();
        });
    }
    
    // --- INITIALIZATION ---

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Flatpickr for delivery date
        const deliveryDateInput = document.getElementById(deliveryDateField);
        const deliveryDateHidden = document.getElementById('delivery-date-hidden');
        if (deliveryDateInput) {
            const availableDates = /*[[${availableDates}]]*/ [];
            flatpickr(deliveryDateInput, {
                enable: availableDates,
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr, instance) {
                    if (deliveryDateHidden) deliveryDateHidden.value = dateStr;
                    checkFormValidity();
                }
            });
        }

        // Initial check for shipping cost if postal code is pre-filled
        if (postalCodeInput && postalCodeInput.value) {
            calculateShipping();
        } else {
            updateOrderSummary();
        }
        
        // Initial form validity check
        checkFormValidity();
    });

    /*]]>*/
</script>

</body>
</html>