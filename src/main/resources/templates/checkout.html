<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Cookiegram Bakery - Checkout</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <script th:src="@{/js/theme-loader.js}"></script>

    <style>
       body {
         font-family: 'Poppins', sans-serif;
         background-color: #f8f9fa;
       }
       main {
         padding-top: 7rem;
         padding-bottom: 7rem;
       }
       .color-swatch {
         display: inline-block;
         width: 20px;
         height: 20px;
         border-radius: 50%;
         border: 1px solid #ccc;
         vertical-align: middle;
         margin-right: 8px;
         background-color: #eee;
       }
       #shipping-cost-loader {
           display: none; /* Hide spinner by default */
       }
    </style>
</head>
<body>

<div th:replace="fragments/nav :: mainNav"></div>

<main class="container">
    <div class="row g-5">
        <div class="col-md-6">
            <h2 class="mb-4">Checkout</h2>
            <div class="card">
                <div class="card-body">
                    <form th:action="@{/charge}" method="post" id="payment-form">
                        
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="amount" id="amount-hidden" th:value="${amount}" />
                        <input type="hidden" name="shippingCost" id="shipping-cost-hidden" value="0.0" />
                        
                        <div th:if="${not #authorization.expression('isAuthenticated()')}">
                            <h5 class="mb-3">Contact Information</h5>
                            <div class="mb-3">
                                <label for="guestEmail" class="form-label">Email</label>
                                <input type="email" id="guestEmail" name="guestEmail" class="form-control" required>
                            </div>
                        </div>

                        <h5 class="mb-3 mt-4">Shipping Address</h5>
                        
                        <div class="mb-3">
                            <label for="shippingName" class="form-label">Full Name</label>
                            <input type="text" id="shippingName" name="shippingName" class="form-control" th:value="${defaultName}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="shippingAddressLine1" class="form-label">Address Line 1</label>
                            <input type="text" id="shippingAddressLine1" name="shippingAddressLine1" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="shippingAddressLine2" class="form-label">Address Line 2 (Optional)</label>
                            <input type="text" id="shippingAddressLine2" name="shippingAddressLine2" class="form-control">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="shippingCity" class="form-label">City</label>
                                <input type="text" id="shippingCity" name="shippingCity" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="shippingProvince" class="form-label">Province</label>
                                <input type="text" id="shippingProvince" name="shippingProvince" class="form-control" placeholder="e.g., ON" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="shippingPostalCode" class="form-label">Postal Code</label>
                                <input type="text" id="shippingPostalCode" name="shippingPostalCode" class="form-control" placeholder="A1B 2C3" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="shippingCountry" class="form-label">Country</label>
                                <input type="text" id="shippingCountry" name="shippingCountry" class="form-control" value="Canada" required>
                            </div>
                        </div>
                        
                        <h5 class="mb-3 mt-4">Payment</h5>
                        <div class="mb-3">
                            <label for="card-element" class="form-label">Credit or debit card</label>
                            <div id="card-element" class="form-control"></div>
                            <div id="card-errors" role="alert" class="text-danger mt-2"></div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="payment-button" disabled>
                                <span id="payment-button-loader" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                <span id="payment-button-text">Submit Payment</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <h2 class="mb-4">Order Summary</h2>
            <div class="card">
                <div class="card-body">
                    <div class="list-group list-group-flush mb-3">
                        <div th:each="item : ${cartItems}" class="list-group-item p-3">
                            <div class="row align-items-center">
                                <div class="col-2">
                                    <img th:src="@{/images/yourmessagehere-yellow-2022.png}" alt="Cookie" class="img-fluid" style="max-width: 50px;">
                                </div>
                                <div class="col-7">
                                    <h6 class="mb-0" th:text="${item.name}">Large Cookiegram</h6>
                                    <small class="text-muted" th:text="${item.message}">"Happy Birthday!"</small>
                                    <div>
                                        <span class="color-swatch" th:style="'background-color: ' + ${item.icingColorHex}"></span>
                                        <small th:text="${item.icingColorName}">Cool Blue</small>
                                    </div>
                                </div>
                                <div class="col-3 text-end">
                                    <span class="fw-bold" th:text="|${'$'}${#numbers.formatDecimal(item.price, 1, 2)}|">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            Subtotal
                            <span class="fw-bold" id="subtotal" th:data-subtotal="${subtotal}" th:text="|${'$'}${#numbers.formatDecimal(subtotal, 1, 2)}|">$0.00</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            Taxes (13%)
                            <span class="fw-bold" id="tax" th:data-tax="${tax}" th:text="|${'$'}${#numbers.formatDecimal(tax, 1, 2)}|">$0.00</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span>
                                Shipping
                                <span id="shipping-cost-loader" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
                            </span>
                            <span class="fw-bold" id="shipping-cost-display">$0.00</span>
                        </li>
                        <div id="shipping-error" class="text-danger mb-2" style="font-size: 0.9em; padding-left: 1.25rem;"></div>

                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 fw-bold h5">
                            Total
                            <span id="total-display" th:text="|${'$'}${#numbers.formatDecimal(total, 1, 2)}|">$0.00</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="fragments/footer :: mainFooter"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://js.stripe.com/v3/"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    
    // --- (CSRF, Stripe, Elements, State... all correct) ---
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    const stripe = Stripe(/*[[${stripePublicKey}]]*/);
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');
    const form = document.getElementById('payment-form');
    const paymentButton = document.getElementById('payment-button');
    const cardErrorsEl = document.getElementById('card-errors');
    const shippingLoaderEl = document.getElementById('shipping-cost-loader');
    const shippingErrorEl = document.getElementById('shipping-error');
    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const shippingCostDisplayEl = document.getElementById('shipping-cost-display');
    const totalDisplayEl = document.getElementById('total-display');
    const amountHiddenEl = document.getElementById('amount-hidden');
    const shippingCostHiddenEl = document.getElementById('shipping-cost-hidden');
    let subtotal = parseFloat(subtotalEl.getAttribute('data-subtotal'));
    let tax = parseFloat(taxEl.getAttribute('data-tax'));
    let currentShippingCost = 0.0;
    
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    async function calculateShipping() {
        toggleSpinner(true); 
        shippingErrorEl.textContent = ''; 
        
        const address = {
            name: document.getElementById('shippingName').value,
            addressLine1: document.getElementById('shippingAddressLine1').value,
            addressLine2: document.getElementById('shippingAddressLine2').value,
            city: document.getElementById('shippingCity').value,
            province: document.getElementById('shippingProvince').value,
            postalCode: document.getElementById('shippingPostalCode').value,
            country: document.getElementById('shippingCountry').value
        };

        if (!address.postalCode) {
            shippingErrorEl.textContent = ''; 
            toggleSpinner(false);
            return; 
        }

        try {
            const response = await fetch('/api/shipping/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken 
                },
                body: JSON.stringify(address)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Could not calculate shipping.');
            }

            currentShippingCost = parseFloat(data.shippingCost);
            updateOrderSummary();
            paymentButton.disabled = false;
            shippingErrorEl.textContent = '';

        } catch (error) {
            shippingErrorEl.textContent = error.message;
            paymentButton.disabled = true;
        } finally {
            toggleSpinner(false);
        }
    }

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        togglePaymentSpinner(true);
        const {token, error} = await stripe.createToken(cardElement);
        if (error) {
            cardErrorsEl.textContent = error.message;
            togglePaymentSpinner(false);
        } else {
            const hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'stripeToken');
            hiddenInput.setAttribute('value', token.id);
            form.appendChild(hiddenInput);
            form.submit();
        }
    });

    function updateOrderSummary() {
        const newTotal = subtotal + tax + currentShippingCost;
        shippingCostDisplayEl.textContent = `$${currentShippingCost.toFixed(2)}`;
        totalDisplayEl.textContent = `$${newTotal.toFixed(2)}`;
        shippingCostHiddenEl.value = currentShippingCost.toFixed(2);
        amountHiddenEl.value = (newTotal * 100).toFixed(0);
    }

    function toggleSpinner(isLoading) {
        shippingLoaderEl.style.display = isLoading ? 'inline-block' : 'none';
    }

    function togglePaymentSpinner(isLoading) {
        const textEl = document.getElementById('payment-button-text');
        const spinnerEl = document.getElementById('payment-button-loader');
        if (isLoading) {
            textEl.style.display = 'none';
            spinnerEl.style.display = 'inline-block';
            paymentButton.disabled = true;
        } else {
            textEl.style.display = 'inline-block';
            spinnerEl.style.display = 'none';
            paymentButton.disabled = (currentShippingCost < 0);
        }
    }
    
    const debouncedCalculateShipping = debounce(calculateShipping, 600);
    const addressFields = ['shippingName', 'shippingAddressLine1', 'shippingAddressLine2', 'shippingCity', 'shippingProvince', 'shippingPostalCode', 'shippingCountry'];
    
    addressFields.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', () => {
                paymentButton.disabled = true; 
                shippingErrorEl.textContent = '';
                debouncedCalculateShipping();
            });
        }
    });

    // --- FIX 4: ADDED BACK THE PAGE-LOAD CALCULATOR ---
    document.addEventListener('DOMContentLoaded', () => {
        // Check if postal code is already filled (by autocomplete)
        const initialPostalCode = document.getElementById('shippingPostalCode').value;
        if (initialPostalCode) {
            calculateShipping();
        }
    });

    /*]]>*/
</script>

</body>
</html>